<template>
  <div class="login-page">
    <UserForm
      :fields="fields"
      :formData="formData"
      :endPoint="endPoint"
      :pageType="pageType"
      :alertMessage="alertMessage"
      @input="this.formData[$event.fieldName] = $event.value"
      @clickSubmitButton="login"
    />
  </div>
</template>

<script lang="ts">
import { defineComponent } from "vue";
import UserForm, { UserFormFieldInfo } from "@/components/UserForm.vue";
import store from "@/store";

export default defineComponent({
  name: "Login",
  store: store,
  components: { UserForm },
  data() {
    return {
      fields: [
        {
          fieldName: "email",
          nameDisplayed: "Email",
          type: "email",
          required: false,
          pattern: "[A-Za-z0-9._%+-]+@[a-z0-9.-]+.[a-z]{2,4}$",
          placeholder: " ",
          shouldAlert: false,
        },
        {
          fieldName: "password",
          nameDisplayed: "Password",
          type: "password",
          required: false,
          pattern: "[a-z0-9A-Z]+",
          placeholder: " ",
          shouldAlert: false,
        },
      ] as UserFormFieldInfo[],
      formData: {
        email: "",
        password: "",
      } as any,
      endPoint: "http://127.0.0.1:8000/api/login" as string,
      pageType: "Login" as string,
      alertMessage: "",
    };
  },
  methods: {
    async login(): Promise<any> {
      let requestBody = new URLSearchParams();
      for (let each in this.formData) {
        requestBody.append(each, this.formData[each]);
      }
      await store.dispatch("checkLoginStatus", requestBody);

      let loginStatus = store.state.loginStatus;
      if (store.state.isLoggedIn) this.$router.push("/");
      else if (loginStatus === "user not found") {
        this.alertMessage = store.state.loginStatus;
        this.formData.email = "";
        this.fields
          .filter((e) => e.fieldName === "email")
          .forEach((e) => (e.shouldAlert = true));
        this.formData.password = "";
        this.fields
          .filter((e) => e.fieldName === "password")
          .forEach((e) => (e.shouldAlert = true));
      } else if (loginStatus === "wrong password") {
        this.alertMessage = store.state.loginStatus;
        this.formData.password = "";
        this.fields
          .filter((e) => e.fieldName === "password")
          .forEach((e) => (e.shouldAlert = true));
      }
    },
  },
});
</script>

<style lang="scss" scoped>
</style>
